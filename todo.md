{'AWSTemplateFormatVersion': '2010-09-09', 'Mappings': {'RegionConfig': {'us-east-1': {'AMIID': 'ami-097e3d1cdb541f43e', 'InstanceType': 't3.medium', 'ARN': 'arn:aws:sns:us-east-1:496623101743:CloudwatchAlarms'}, 'us-east-2': {'AMIID': 'ami-0fbd313043845c4f2', 'InstanceType': 't3.small', 'ARN': 'arn:aws:sns:us-east-2:496623101743:CloudwatchAlarms'}, 'eu-central-1': {'AMIID': 'ami-074dc9dd588b6ea52', 'InstanceType': 't3.small', 'ARN': 'arn:aws:sns:ap-southeast-2:496623101743:CloudwatchAlarms'}, 'eu-west-1': {'AMIID': 'ami-0bf45a5f4ab05b949', 'InstanceType': 't3.small', 'ARN': 'arn:aws:sns:eu-west-1:496623101743:CloudwatchAlarms'}, 'ap-southeast-2': {'AMIID': 'ami-07610e278b1ddf331', 'InstanceType': 't3.small', 'ARN': 'arn:aws:sns:ap-southeast-2:496623101743:CloudwatchAlarms'}}}, 'Parameters': {'AsgMinSize': {'Default': 1, 'Type': 'Number'}, 'AMIID': {'Default': 't3.small', 'Type': 'String'}, 'InstanceSize': {'Default': 't3.small', 'Type': 'String'}, 'LAMBDAFUNCTIONNAME': {'Default': 'ECS_DB_Sync_Scheduler', 'Type': 'String', 'Description': 'Name of the lambda function'}, 'ENVIRONMENT': {'Default': 'us-east-1', 'Type': 'String', 'Description': 'Environment tag'}, 'AsgDesiredSize': {'Default': 1, 'Type': 'Number'}, 'DOCKERTAG': {'Default': 'prod', 'Type': 'String', 'Description': 'docker image tag e.g. latest, stage'}}, 'Resources': {'EcsIamInstanceProfile': {'Type': 'AWS::IAM::InstanceProfile', 'Properties': {'Roles': [{'Fn::Ref': 'EcsTaskRole'}]}}, 'EcsInstanceLc': {'Type': 'AWS::AutoScaling::LaunchConfiguration', 'Properties': {'UserData': {'Fn::Base64': {'Fn::Sub': '#!/bin/bash -xe\necho ECS_CLUSTER=${EcsCluster} >> /etc/ecs/ecs.config yum install -y aws-cfn-bootstrap /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource ECSAutoScalingGroup --region ${AWS::Region}\n'}}, 'ImageId': {'Ref': 'AMIID'}, 'KeyName': 'dbSyncKeyPair', 'BlockDeviceMappings': [{'DeviceName': '/dev/xvdcz', 'Ebs': {'Encrypted': True, 'VolumeSize': 22, 'VolumeType': 'gp2'}}], 'SecurityGroups': [{'Fn::Ref': 'EcsSecurityGroup'}], 'IamInstanceProfile': 'ecsInstanceRole', 'InstanceType': {'Ref': 'InstanceSize'}, 'AssociatePublicIpAddress': True}}, 'EcsSecurityGroup': {'Type': 'AWS::EC2::SecurityGroup', 'Properties': {'VpcId': {'Fn::ImportValue': 'VPC-VPC'}, 'GroupDescription': 'ECS Allowed Ports'}}, 'EcsInstanceAsg': {'Type': 'AWS::AutoScaling::AutoScalingGroup', 'Properties': {'MinSize': 2, 'MaxSize': 4, 'VPCZoneIdentifier': [{'Fn::ImportValue': 'VPC-SubnetAPublic'}, {'Fn::ImportValue': 'VPC-SubnetBPublic'}], 'DesiredCapacity': 2, 'Tags': [{'Value': 'DB Sync Execution', 'PropagateAtLaunch': True, 'Key': 'Name'}, {'Value': 'db_sync', 'PropagateAtLaunch': True, 'Key': 'product'}], 'LaunchConfigurationName': {'Fn::Ref': 'EcsInstanceLc'}}, 'UpdatePolicy': {'AutoScalingReplacingUpdate': {'WillReplace': 'true'}}}, 'PublicRouteViaIgw': {'Type': 'AWS::EC2::Route', 'Properties': {'GatewayId': {'Ref': 'InternetGateway'}, 'DestinationCidrBlock': '0.0.0.0/0', 'RouteTableId': {'Ref': 'RouteViaIgw'}}, 'DependsOn': 'AttachGateway'}, 'TaskExecutionRole': {'Type': 'AWS::IAM::Role', 'Properties': {'Path': '/', 'Policies': [{'PolicyName': 'Logs', 'PolicyDocument': {'Version': '2012-10-17', 'Statement': [{'Action': ['ecr:GetAuthorizationToken', 'ecr:BatchCheckLayerAvailability', 'ecr:GetDownloadUrlForLayer', 'ecr:BatchGetImage', 'logs:CreateLogStream', 'logs:PutLogEvents'], 'Resource': '*', 'Effect': 'Allow'}]}}], 'AssumeRolePolicyDocument': {'Version': datetime.date(2012, 10, 17), 'Statement': [{'Action': ['sts:AssumeRole'], 'Effect': 'Allow', 'Principal': {'Service': ['ecs-tasks.amazonaws.com']}}]}}}, 'InternetGateway': {'Type': 'AWS::EC2::InternetGateway'}, 'EcsCluster': {'Type': 'AWS::ECS::Cluster', 'Properties': {'ClusterName': {'Fn::Join': ['-', ['DBSyncCluster', {'Fn::Ref': 'ENVIRONMENT'}]]}}}, 'LambdaTrigger': {'Type': 'AWS::Events::Rule', 'Properties': {'State': 'ENABLED', 'ScheduleExpression': 'cron(7, */4 * * ? *)', 'Description': 'Rule to run dbsync scheduler lambda', 'Targets': [{'Id': 'dbsync_lambda', 'Arn': {'Fn::GetAtt': 'SchedulerLambda.Arn'}}]}}, 'TaskDefinition': {'Type': 'AWS::ECS::TaskDefinition', 'Properties': {'TaskRoleArn': {'Fn::GetAtt': 'EcsTaskRole.Arn'}, 'ContainerDefinitions': [{'Environment': [{'Name': 'AWS_DEFAULT_REGION', 'Value': {'Fn::Ref': 'AWS::Region'}}, {'Name': 'ENVIRONMENT', 'Value': {'Fn::Ref': 'ENVIRONMENT'}}, {'Name': 'ORGID', 'Value': 'nil'}, {'Name': 'SHOULDREFRESH', 'Value': 'nil'}, {'Name': 'LOGLEVEL', 'Value': 'INFO'}, {'Name': 'S3_BUCKET', 'Value': {'Fn::Ref': 'S3DataBucket'}}], 'LogConfiguration': {'LogDriver': 'awslogs', 'Options': {'awslogs-region': {'Fn::Ref': 'AWS::Region'}, 'awslogs-stream-prefix': 'dbsync', 'awslogs-group': 'ecs-dbsync'}}, 'Name': 'DB_Sync', 'Memory': 500, 'Image': {'Fn::Join': ['', ['496623101743.dkr.ecr.', "Fn::Ref 'AWS::Region'", '.amazonaws.com/dbsync:', {'Fn::Ref': 'DOCKERTAG'}]]}, 'Cpu': 30, 'Essential': True}], 'RequiresCompatibilities': ['EC2']}}, 'LambdaRole': {'Type': 'AWS::IAM::Role', 'Properties': {'Path': '/', 'Policies': [{'PolicyName': 'root', 'PolicyDocument': {'Version': '2012-10-17', 'Statement': [{'Action': ['logs:CreateLogGroup', 'logs:CreateLogStream', 'logs:PutLogEvents'], 'Resource': '*', 'Effect': 'Allow'}, {'Action': ['dynamodb:BatchGetItem', 'dynamodb:GetItem', 'dynamodb:Query', 'dynamodb:Scan'], 'Resource': ['arn:aws:dynamodb:*:496623101743:table/db_sync_configuration', 'arn:aws:dynamodb:*:496623101743:table/db_sync_status'], 'Effect': 'Allow'}, {'Action': ['ecs:DescribeTasks', 'ecs:ListTaskDefinitionFamilies', 'ecs:ListTaskDefinitions', 'ecs:ListTasks', 'ecs:Poll', 'ecs:RunTask', 'ecs:StartTask', 'ecs:ListContainerInstances'], 'Resource': '*', 'Effect': 'Allow'}, {'Action': ['iam:PassRole'], 'Resource': [{'Fn::GetAtt': 'EcsTaskRole.Arn'}, {'Fn::GetAtt': 'TaskExecutionRole.Arn'}], 'Effect': 'Allow'}, {'Action': ['sns:Publish'], 'Resource': 'arn:aws:sns:us-east-1:496623101743:CloudwatchAlarms', 'Effect': 'Allow'}]}}], 'AssumeRolePolicyDocument': {'Version': '2012-10-17', 'Statement': [{'Action': ['sts:AssumeRole'], 'Effect': 'Allow', 'Principal': {'Service': ['lambda.amazonaws.com']}}]}}}, 'Vpc': {'Type': 'AWS::EC2::VPC', 'Properties': {'EnableDnsSupport': 'true', 'CidrBlock': '10.0.0.0/16', 'EnableDnsHostnames': 'true'}}, 'SchedulerLambda': {'Type': 'AWS::Lambda::Function', 'Properties': {'Code': {'ZipFile': 'console.log()'}, 'Description': 'Lambda function used to schedule database updates', 'MemorySize': 128, 'Environment': {'Variables': {'SUBNET': {'Fn::ImportValue': 'VPC-SubnetAPublic'}, 'TASK_ARN': {'Fn::GetAtt': 'TaskDefinition'}, 'ENVIRONMENT': {'Ref': 'ENVIRONMENT'}, 'ECS_CLUSTER': {'Fn::GetAtt': 'EcsCluster'}, 'ECS_ARN': {'Fn::GetAtt': 'EcsInstanceAsg'}, 'FARGATE_TASK_ARN': {'Ref': 'FargateTaskDefinition'}, 'CONTAINER_INSTANCE': {'Ref': 'TaskDefinition'}, 'ECS_ROLE': {'Fn::GetAtt': 'EcsTaskRole.Arn'}}}, 'Handler': 'lambda.lambda_handler', 'Role': {'Fn::GetAtt': 'LambdaRole.Arn'}, 'Timeout': 60, 'Runtime': 'python2.7', 'FunctionName': {'Ref': 'LAMBDAFUNCTIONNAME'}}}, 'AttachGateway': {'Type': 'AWS::EC2::VPCGatewayAttachment', 'Properties': {'VpcId': {'Ref': 'Vpc'}, 'InternetGatewayId': {'Ref': 'InternetGateway'}}}, 'PubSubnetAz1': {'Type': 'AWS::EC2::Subnet', 'Properties': {'VpcId': {'Ref': 'Vpc'}, 'CidrBlock': '10.0.0.0/24', 'MapPublicIpOnLaunch': True}}, 'PubSubnetAz2': {'Type': 'AWS::EC2::Subnet', 'Properties': {'VpcId': {'Ref': 'Vpc'}, 'CidrBlock': '10.0.1.0/24', 'MapPublicIpOnLaunch': True}}, 'ConversationAttributeFirehose': {'Type': 'AWS::KinesisFirehose::DeliveryStream', 'Properties': {'DeliveryStreamType': 'DirectPut', 'DeliveryStreamName': 'ConversationAttributeFirehose', 'S3DestinationConfiguration': {'CompressionFormat': 'GZIP', 'RoleARN': {'Fn::GetAtt': 'FirehoseRole.Arn'}, 'Prefix': 'firehose/conversationattributes/', 'BucketARN': {'Fn::GetAtt': 'S3DataBucket.Arn'}, 'BufferingHints': {'IntervalInSeconds': 900, 'SizeInMBs': 120}}}}, 'PubSubnet1RouteTableAssociation': {'Type': 'AWS::EC2::SubnetRouteTableAssociation', 'Properties': {'SubnetId': {'Ref': 'PubSubnetAz1'}, 'RouteTableId': {'Ref': 'RouteViaIgw'}}}, 'FargateTaskDefinition': {'Type': 'AWS::ECS::TaskDefinition', 'Properties': {'Cpu': 2048, 'ExecutionRoleArn': {'Fn::Ref': 'TaskExecutionRole'}, 'NetworkMode': 'awsvpc', 'Memory': 4096, 'TaskRoleArn': {'Fn::GetAtt': 'EcsTaskRole.Arn'}, 'ContainerDefinitions': [{'Environment': [{'Name': 'AWS_DEFAULT_REGION', 'Value': {'Fn::Ref': 'AWS::Region'}}, {'Name': 'ENVIRONMENT', 'Value': {'Fn::Ref': 'ENVIRONMENT'}}, {'Name': 'ORGID', 'Value': 'nil'}, {'Name': 'SHOULDREFRESH', 'Value': 'nil'}, {'Name': 'LOGLEVEL', 'Value': 'INFO'}, {'Name': 'S3_BUCKET', 'Value': {'Fn::Ref': 'S3DataBucket'}}], 'LogConfiguration': {'LogDriver': 'awslogs', 'Options': {'awslogs-region': {'Fn::Ref': 'AWS::Region'}, 'awslogs-stream-prefix': 'dbsync', 'awslogs-group': 'ecs-dbsync'}}, 'Name': 'DB_Sync', 'Memory': 4096, 'Image': {'Fn::Join': ['', ['496623101743.dkr.ecr.', {'Fn::Ref': 'AWS::Region'}, '.amazonaws.com/dbsync:', {'Fn::Ref': 'DOCKERTAG'}]]}, 'Cpu': 2048, 'Essential': True}], 'RequiresCompatibilities': ['FARGATE']}}, 'LambdaTriggerError': {'Type': 'AWS::CloudWatch::Alarm', 'Properties': {'EvaluationPeriods': '1', 'Dimensions': [{'Name': 'FunctionName', 'Value': {'Ref': 'LambdaTrigger'}}], 'AlarmActions': [{'Fn::Join': ['', ['arn:aws:sns:', {'Ref': 'AWS::Region'}, ':496623101743:CloudwatchAlarms']]}], 'Threshold': '1', 'AlarmDescription': 'Alarm for if the dbsync trigger errors', 'Namespace': 'AWS/Lambda', 'Period': '300', 'ComparisonOperator': 'GreaterThanOrEqualToThreshold', 'AlarmName': 'DbSyncTriggerLambda', 'Statistic': 'Sum', 'TreatMissingData': 'notBreaching', 'MetricName': 'Errors'}}, 'ConversationFirehose': {'Type': 'AWS::KinesisFirehose::DeliveryStream', 'Properties': {'DeliveryStreamType': 'DirectPut', 'DeliveryStreamName': 'ConversationFirehose', 'S3DestinationConfiguration': {'CompressionFormat': 'GZIP', 'RoleARN': {'Fn::GetAtt': 'FirehoseRole.Arn'}, 'Prefix': 'firehose/conversations/', 'BucketARN': {'Fn::GetAtt': 'S3DataBucket.Arn'}, 'BufferingHints': {'IntervalInSeconds': 900, 'SizeInMBs': 120}}}}, 'RouteViaIgw': {'Type': 'AWS::EC2::RouteTable', 'Properties': {'VpcId': {'Ref': 'Vpc'}}}, 'LambdaInvokePermission': {'Type': 'AWS::Lambda::Permission', 'Properties': {'Action': 'lambda:InvokeFunction', 'Principal': 'events.amazonaws.com', 'SourceArn': {'Fn::GetAtt': 'LambdaTrigger.Arn'}, 'FunctionName': {'Fn::GetAtt': 'SchedulerLambda.Arn'}}}, 'EcsTaskRole': {'Type': 'AWS::IAM::Role', 'Properties': {'Path': '/', 'Policies': [{'PolicyName': 'Logs', 'PolicyDocument': {'Version': '2012-10-17', 'Statement': [{'Action': ['logs:CreateLogGroup', 'logs:CreateLogStream', 'logs:PutLogEvents', 'logs:DescribeLogStreams'], 'Resource': ['arn:aws:logs:*:*:*'], 'Effect': 'Allow'}]}}, {'PolicyName': 'Dynamo', 'PolicyDocument': {'Version': '2012-10-17', 'Statement': [{'Action': ['dynamodb:PutItem'], 'Resource': ['arn:aws:dynamodb:*:496623101743:table/db_sync_status', 'arn:aws:dynamodb:*:496623101743:table/db_sync_usage', 'arn:aws:dynamodb:*:496623101743:table/db_sync_configuration_items', 'arn:aws:dynamodb:*:496623101743:table/db_sync_bookmarks'], 'Effect': 'Allow'}, {'Action': ['dynamodb:GetItem'], 'Resource': ['arn:aws:dynamodb:*:496623101743:table/db_sync_configuration', 'arn:aws:dynamodb:*:496623101743:table/db_sync_configuration_items', 'arn:aws:dynamodb:*:496623101743:table/db_sync_bookmarks', 'arn:aws:dynamodb:*:496623101743:table/db_sync_status'], 'Effect': 'Allow'}]}}, {'PolicyName': 'S3', 'PolicyDocument': {'Version': '2012-10-17', 'Statement': [{'Action': ['s3:GetObject'], 'Resource': ['arn:aws:s3:::dbsync-config/*', 'arn:aws:s3:::dbsync-config'], 'Effect': 'Allow'}, {'Action': ['s3:*'], 'Resource': ['arn:aws:s3:::pureinsights-build-out', 'arn:aws:s3:::pureinsights-build-out/*', {'Fn::GetAtt': 'S3DataBucket.Arn'}, {'Fn::Join': ['/', [{'Fn::GetAtt': 'S3DataBucket.Arn'}, '*']]}], 'Effect': 'Allow'}]}}, {'PolicyName': 'firehose', 'PolicyDocument': {'Version': '2012-10-17', 'Statement': [{'Action': ['firehose:DeleteDeliveryStream', 'firehose:PutRecord', 'firehose:PutRecordBatch', 'firehose:UpdateDestination'], 'Resource': [{'Fn::GetAtt': 'ConversationAttributeFirehose.Arn'}, {'Fn::GetAtt': 'ConversationFirehose.Arn'}], 'Effect': 'Allow'}]}}, {'PolicyName': 'Athena', 'PolicyDocument': {'Version': '2012-10-17', 'Statement': [{'Action': ['s3:*'], 'Resource': [{'Fn::Join': ['', ['arn:aws:s3:::', 'pibi-query-output-*', '/*']]}, {'Fn::Join': ['', ['arn:aws:s3:::', 'pibi-query-output-*']]}], 'Effect': 'Allow'}, {'Action': ['athena:StartQueryExecution', 'athena:GetQueryResults', 'athena:GetQueryResultsStream', 'athena:GetQueryExecution', 'athena:RunQuery', 'athena:StopQueryExecution', 'glue:GetTable', 'glue:GetTables', 'glue:GetDatabase', 'glue:GetDatabases', 'glue:GetPartition', 'glue:GetPartitions'], 'Resource': ['*'], 'Effect': 'Allow'}, {'Action': ['s3:ListBucket', 's3:GetObject'], 'Resource': ['*'], 'Effect': 'Allow'}]}}], 'AssumeRolePolicyDocument': {'Version': '2012-10-17', 'Statement': [{'Action': ['sts:AssumeRole'], 'Effect': 'Allow', 'Principal': {'Service': ['ecs-tasks.amazonaws.com']}}]}}}, 'S3DataBucket': {'Type': 'AWS::S3::Bucket', 'Properties': {'BucketEncryption': {'ServerSideEncryptionConfiguration': [{'ServerSideEncryptionByDefault': {'SSEAlgorithm': 'AES256'}}]}, 'BucketName': {'Fn::Join': ['-', ['pureclouddata', {'Ref': 'AWS::Region'}]]}}}, 'FirehoseRole': {'Type': 'AWS::IAM::Role', 'Properties': {'Path': '/', 'Policies': [{'PolicyName': 'S3', 'PolicyDocument': {'Version': '2012-10-17', 'Statement': [{'Action': ['s3:AbortMultipartUpload', 's3:GetBucketLocation', 's3:GetObject', 's3:ListBucket', 's3:ListBucketMultipartUploads', 's3:PutObject'], 'Resource': [{'Fn::GetAtt': 'S3DataBucket.Arn'}, {'Fn::Join': ['/', [{'Fn::GetAtt': 'S3DataBucket.Arn'}, '*']]}], 'Effect': 'Allow'}]}}], 'AssumeRolePolicyDocument': {'Version': '2012-10-17', 'Statement': [{'Action': ['sts:AssumeRole'], 'Effect': 'Allow', 'Principal': {'Service': ['firehose.amazonaws.com']}}]}}}, 'PubSubnet2RouteTableAssociation': {'Type': 'AWS::EC2::SubnetRouteTableAssociation', 'Properties': {'SubnetId': {'Ref': 'PubSubnetAz2'}, 'RouteTableId': {'Ref': 'RouteViaIgw'}}}}, 'Description': 'Stack for dbsync ecs configuration'}
datetime.date(2012, 10, 17) is not JSON serializable
not in e
datetime.date(2012, 10, 17) is not JSON serializable
Traceback (most recent call last):
  File "/usr/lib/python2.7/site-packages/cfn_runner/__main__.py", line 125, in main
    raise e
TypeError: datetime.date(2012, 10, 17) is not JSON serializable


